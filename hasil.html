<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Hasil Diagnosa - Bengkel Waras</title>
<style>
  body { font-family: Arial, Helvetica, sans-serif; background:#f3f6fb; margin:0; color:#102434; }
  header { background:#0f4c81; color:white; padding:10px 16px; display:flex; align-items:center; justify-content:space-between; }
  .container { max-width:920px; margin:16px auto; padding:0 12px; }
  .card { background:white; border-radius:8px; padding:14px; box-shadow:0 6px 18px rgba(12,20,40,0.06); margin-bottom:12px; }
  table { width:100%; border-collapse:collapse; }
  th, td { padding:10px 8px; border-bottom:1px solid #eef2f6; text-align:left; font-size:14px; }
  .badge { background:#e6f6ff; color:#065f9b; padding:6px 8px; border-radius:6px; font-weight:700; display:inline-block; }
  .btn { padding:10px 14px; border-radius:8px; color:white; text-decoration:none; display:inline-block; border:none; cursor:pointer; }
  .btn-print { background:#059669; }
  .btn-back { background:#0f4c81; }
  .section-title { background:#dfeff7; padding:8px; border-radius:6px; margin-bottom:8px; color:#083a63; font-weight:700; }
  .trace { background:#0f172a; color:#dbeafe; padding:10px; border-radius:6px; max-height:240px; overflow:auto; font-size:13px; }
  .conclude { background:#dff7ea; padding:12px; border-radius:8px; margin-top:10px; }
  .sol { background:#ffffff; padding:12px; border-radius:8px; margin-top:10px; border:1px dashed #cfeadf; }
</style>
</head>
<body>
  <header>
    <div>Bengkel Waras</div>
    <div></div>
  </header>

  <div class="container">
    <div class="card">
      <h3>Berikut Hasil Diagnosa Kerusakan Sepeda Motor Anda</h3>
      <p class="badge">Tgl. Diagnosa : <span id="tglDiag"></span></p>

      <div class="section-title">Gejala Yang Dipilih</div>
      <table id="tblSelected">
        <thead><tr><th>Gejala</th><th>Tingkat Keyakinan</th></tr></thead>
        <tbody></tbody>
      </table>

    </div>

    <div class="card">
      <div class="section-title">Perhitungan Rule dan Nilai CF</div>
      <div id="rulesUsed"></div>

      <div style="margin-top:12px;">
        <div class="section-title">Kesimpulan</div>
        <div id="conclusionArea"></div>
      </div>

      <div style="margin-top:12px; display:flex; gap:10px; justify-content:flex-end;">
        <button class="btn btn-back" id="btnBack">Kembali</button>
        <button class="btn btn-print" id="btnPrint">Download</button>
      </div>

      <div style="margin-top:12px;">
        <div class="section-title">Trace Aturan (log engine)</div>
        <div class="trace" id="traceOut">-</div>
      </div>
    </div>
  </div>

<script src="inference.js"></script>
<script>
(async function(){
  // load inputs
  const raw = localStorage.getItem('diagnosaInputs');
  if (!raw) {
    alert('Tidak ada data diagnosa. Kembali ke halaman diagnosa.');
    window.location.href = 'diagnosa.html';
    return;
  }
  const inputs = JSON.parse(raw);

  // load rules
  const rulesData = await window.EI.loadRules('rules.json');

  // show date
  document.getElementById('tglDiag').textContent = new Date().toLocaleDateString();

  // show selected gejala (only those not 'Tidak')
  const symptomMap = {
    "G-01":"Mesin tersendat-sendat saat dijalan",
    "G-02":"Bahan bakar bocor keluar dari selang pembuangan",
    "G-03":"Mesin motor susah dinyalakan",
    "G-04":"Tarikan pada gas seret",
    "G-05":"Bahan bakar boros",
    "G-06":"Mesin mati saat di gas",
    "G-07":"Mesin motor tidak bisa stasioner",
    "G-08":"Mesin motor ngegas dengan sendirinya",
    "G-09":"Suara kasar pada knalpot",
    "G-10":"Mesin sering macet / mati mendadak",
    "G-11":"Sistem starter elektrik tidak berfungsi",
    "G-12":"Cahaya lampu motor menjadi redup atau tidak berfungsi",
    "G-13":"Klakson menjadi kurang nyaring atau tidak berfungsi",
    "G-14":"Mesin motor cepat panas",
    "G-15":"Knalpot mengeluarkan asap hitam",
    "G-16":"Knalpot mengeluarkan asap putih",
    "G-17":"Lampu ornament mati pada saat mesin dihidupkan",
    "G-18":"Oli mesin cepat habis",
    "G-19":"Lampu gigi transmisi mati pada saat mesin dihidupkan",
    "G-20":"Busi mudah mati",
    "G-21":"Saat menutup gas pada knalpot berbunyi suara ledakan",
    "G-22":"Matinya sensor bensin",
    "G-23":"Matinya jarum speedometer",
    "G-24":"Tenaga yang dihasilkan lemah",
    "G-25":"Saat memasukkan gigi transmisi timbul suara kasar",
    "G-26":"Gigi transmisi susah dimasukkan",
    "G-27":"Selip terasa sangat ringan saat dihidupkan secara manual",
    "G-28":"Pada saat memindahkan gigi timbul hentakan",
    "G-29":"Saat memasukkan gigi transmisi sering loss",
    "G-30":"Mesin motor tidak bisa dinyalakan",
    "G-31":"Ketika dikick starter terlalu enteng",
    "G-32":"Timbul suara kasar ketika dipakai dijalan yang rusak",
    "G-33":"Oli Sock beker cepat habis",
    "G-34":"Keluar oli pada sock beker depan",
    "G-35":"Motor tidak stabil saat dipakai berbelok",
    "G-36":"Oli rem cepat habis",
    "G-37":"Rem cakram tidak bisa digunakan",
    "G-38":"Aki motor tiba-tiba melemah",
    "G-39":"Roda mengalami ogel",
    "G-40":"Roda motor macet",
    "G-41":"Tidak berbunyi saat dihidupkan menggunakan electric starter",
    "G-42":"Saat dihidupkan electric starter selip tidak mau berputar namun bunyi ada",
    "G-43":"Dynamo starter mengeluarkan suara kasar",
    "G-44":"Dynamo starter panas",
    "G-45":"Gigi prosneling bisa loncat dengan sendirinya"
  };

  const tbody = document.querySelector('#tblSelected tbody');
  tbody.innerHTML = '';
  for (const [k,v] of Object.entries(inputs)) {
    if (v && v !== 'Tidak') {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td><strong>${k}</strong> — ${symptomMap[k] || ''}</td><td>${v}</td>`;
      tbody.appendChild(tr);
    }
  }
  if (tbody.children.length === 0) {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td colspan="2" style="color:#64748b;">(Anda tidak memilih gejala apapun atau semua gejala dipilih 'Tidak')</td>`;
    tbody.appendChild(tr);
  }

  // run inference
  const out = window.EI.runInference(rulesData, inputs);

  // display rules used and their CF contributions (group by conclusion)
  const rulesDiv = document.getElementById('rulesUsed');
  rulesDiv.innerHTML = '';
  // we will list per rule from trace
  if (out.trace.length === 0) {
    rulesDiv.innerHTML = `<p style="color:#475569;">Tidak ada aturan yang terpenuhi berdasarkan input.</p>`;
  } else {
    // create grouped by conclusion map
    const grouped = {};
    out.trace.forEach(t => {
      if (!grouped[t.conclusion]) grouped[t.conclusion] = [];
      grouped[t.conclusion].push(t);
    });

    for (const [concl, entries] of Object.entries(grouped)) {
      // find rule desc from rulesData
      const ruleDesc = rulesData.rules.find(r => r.then === concl)?.desc || '';
      const box = document.createElement('div');
      box.style.marginBottom = '10px';
      let html = `<div style="font-weight:700; color:#083a63;">Kerusakan ${concl} — ${ruleDesc}</div>`;
      html += '<table style="width:100%; margin-top:6px;"><thead><tr><th>Rule</th><th>Kontribusi CF</th><th>Keterangan</th></tr></thead><tbody>';
      entries.forEach(e => {
        const contrib = (e.contribution !== undefined) ? e.contribution : (e.combined || 0);
        html += `<tr><td>${e.ruleId}</td><td>${(contrib*100).toFixed(2)}%</td><td>${e.desc || ''}</td></tr>`;
      });
      html += '</tbody></table>';
      // show final CF for that conclusion (from out.facts)
      const finalCF = out.facts[concl] || 0;
      html += `<div style="margin-top:6px; font-weight:700; color:#065f9b;">Nilai CF akhir: ${(finalCF*100).toFixed(4)}%</div>`;
      box.innerHTML = html;
      rulesDiv.appendChild(box);
    }
  }

  // conclusion: choose top diagnosis (highest CF)
  const conclusionArea = document.getElementById('conclusionArea');
  if (out.diagnoses.length === 0) {
    conclusionArea.innerHTML = `<div class="conclude">Berdasarkan gejala yang Anda pilih, tidak ditemukan diagnosa yang kuat. Silakan periksa kembali gejala atau konsultasikan ke mekanik.</div>`;
  } else {
    const top = out.diagnoses[0];
    // find rule desc mapping for top code
    const desc = rulesData.rules.find(r => r.then === top.code)?.desc || '';
    const solText = getSolutionText(top.code);
    conclusionArea.innerHTML = `
      <div class="conclude">
        Nilai CF paling tinggi adalah <strong>${(top.cf*100).toFixed(4)}%</strong> yaitu <strong>${top.code}</strong> — ${desc}.
      </div>
      <div class="sol">
        <strong>Solusi:</strong><br>
        ${solText}
      </div>
    `;
  }

  // fill trace
  document.getElementById('traceOut').textContent = JSON.stringify(out.trace, null, 2);

  // buttons
  document.getElementById('btnBack').addEventListener('click', () => {
    window.location.href = 'diagnosa.html';
  });
  document.getElementById('btnPrint').addEventListener('click', () => {
    window.print();
  });

  // simple solution text for K-xx (you can extend)
  function getSolutionText(code) {
    const map = {
      "K-01":"Periksa pilot jet dan main jet pada karburator; bersihkan atau ganti bila tersumbat.",
      "K-02":"Lakukan pembersihan karburator dan setel ulang bahan bakar.",
      "K-03":"Periksa tali gas; bersihkan dan ganti bila korosif.",
      "K-04":"Atur setelan karburator agar pas sesuai spesifikasi.",
      "K-05":"Periksa dan ganti aki jika lemah atau tidak berfungsi.",
      "K-06":"Periksa komponen piston dan kompresi; servis di bengkel.",
      "K-07":"Periksa klep—penyetelan atau penggantian jika aus.",
      "K-08":"Periksa kabel/instalasi speedometer dan sensor terkait.",
      "K-09":"Periksa CDI digital dan kabelnya; ganti jika rusak.",
      "K-10":"Periksa rotary transmisi dan perbaiki komponen yang longgar.",
      "K-11":"Periksa komponen rem kopling dan ganti bila aus.",
      "K-12":"Ganti seal sock beker depan yang bocor.",
      "K-13":"Ganti seal master rem yang bocor.",
      "K-14":"Periksa regulator motor; ganti jika rusak.",
      "K-15":"Periksa bearing roda, ganti bila perlu.",
      "K-16":"Periksa electric starter dan dynamo; servis atau ganti."
    };
    return map[code] || "Periksa lebih lanjut di bengkel terdekat.";
  }

})();
</script>
</body>
</html>
